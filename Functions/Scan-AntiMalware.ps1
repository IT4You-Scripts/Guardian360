function Scan-AntiMalware {
    [CmdletBinding()]
    param()

    Write-Host "Iniciando varredura rápida de malwares (Windows Defender)..." -ForegroundColor Cyan
    Write-Log "Início do Scan-AntiMalware."

    try {

        $IsAdmin = (New-Object Security.Principal.WindowsPrincipal(
            [Security.Principal.WindowsIdentity]::GetCurrent()
        )).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

        if (-not $IsAdmin) {

            Write-Host "ERRO: É necessário executar como Administrador para scan completo." -ForegroundColor Red
            Write-Log  "ERRO: Permissão de administrador ausente."

            throw "Permissão insuficiente: requer administrador."
        }

        $paths = @(
            "C:\Program Files\Windows Defender\MpCmdRun.exe",
            "C:\ProgramData\Microsoft\Windows Defender\Platform\*\MpCmdRun.exe"
        )

        $defenderPath = $null

        foreach ($path in $paths) {
            $found = Get-ChildItem -Path $path -File -ErrorAction SilentlyContinue
            if ($found) {
                $defenderPath = $found | Select-Object -First 1
                break
            }
        }

        if ($defenderPath) {

            Write-Host "Atualizando definições..." -ForegroundColor Yellow
            Write-Log  "Atualizando definições..."
            Start-Process $defenderPath.FullName -ArgumentList "-SignatureUpdate" -Wait -WindowStyle Hidden

            Write-Host "Executando varredura rápida..." -ForegroundColor Yellow
            Write-Log  "Executando varredura rápida..."

            $result = Start-Process $defenderPath.FullName `
                -ArgumentList "-Scan -ScanType 1" `
                -Wait -PassThru -WindowStyle Hidden

            switch ($result.ExitCode) {
                0 { Write-Log "Nenhuma ameaça detectada." }
                2 { Write-Log "Ameaças detectadas e tratadas." }
                default { Write-Log "Código de retorno inesperado: $($result.ExitCode)" }
            }

            Write-Host "Varredura finalizada." -ForegroundColor Green
            Write-Log  "Scan-AntiMalware finalizado."

            return [PSCustomObject]@{
                MensagemTecnica = "Scan concluído. ExitCode=$($result.ExitCode)"
                ExitCode        = $result.ExitCode
            }
        }
        else {

            Write-Host "ERRO: MpCmdRun.exe não encontrado." -ForegroundColor Red
            Write-Log  "ERRO: MpCmdRun.exe não encontrado."

            throw "MpCmdRun.exe ausente."
        }
    }
    catch {

        Write-Host "ERRO crítico: $_" -ForegroundColor Red
        Write-Log  ("ERRO crítico: {0}" -f $_)

        throw
    }
}
