# Realiza Varredura de Malware usando Windows Defender
function Scan-AntiMalware {
    Write-Host "Iniciando varredura rápida de malwares (Windows Defender)..." -ForegroundColor Cyan
    Write-Log "Início do Scan-AntiMalware."

    # Verifica se o script está rodando como Administrador
    if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
        Write-Host "ERRO: É necessário executar como Administrador para scan completo e atualização de definições." -ForegroundColor Red
        Write-Log "ERRO: Permissão de administrador ausente."
        return
    }

    # Caminhos possíveis do MpCmdRun.exe
    $paths = @(
        "C:\Program Files\Windows Defender\MpCmdRun.exe",
        "C:\ProgramData\Microsoft\Windows Defender\Platform\*\MpCmdRun.exe"
    )

    $defenderPath = $paths | ForEach-Object { Get-ChildItem -Path $_ -File -ErrorAction SilentlyContinue } | Select-Object -First 1

    if ($defenderPath) {
        try {
            # Atualiza definições
            Write-Host "Atualizando definições de vírus..." -ForegroundColor Yellow
            Write-Log "Atualizando definições de vírus..."
            Start-Process -FilePath $defenderPath.FullName -ArgumentList "-SignatureUpdate" -Wait -WindowStyle Hidden

            # Varredura rápida
            Write-Host "Executando varredura rápida..." -ForegroundColor Yellow
            Write-Log "Executando varredura rápida..."
            $result = Start-Process -FilePath $defenderPath.FullName -ArgumentList "-Scan -ScanType 1" -Wait -PassThru -WindowStyle Hidden

            switch ($result.ExitCode) {
                0 { 
                    Write-Host "Nenhuma ameaça detectada." -ForegroundColor Green
                    Write-Log "Nenhuma ameaça detectada." 
                }
                2 {
                    Write-Host "Ameaças detectadas e tratadas (ou exigem ação)!" -ForegroundColor Red
                    Write-Log "Ameaças detectadas e tratadas (ou exigem ação)!"
                }
                default {
                    Write-Host ("ERRO: Varredura não concluída. Código de saída: {0}" -f $result.ExitCode) -ForegroundColor Yellow
                    Write-Log ("ERRO: Varredura não concluída. Código de saída: {0}" -f $result.ExitCode)
                }
            }
        } catch {
            Write-Host "ERRO: Falha ao executar Windows Defender Scan." -ForegroundColor Red
            Write-Log ("Erro ao executar Windows Defender Scan: {0}" -f $_)
        }
    } else {
        Write-Host "ERRO: MpCmdRun.exe do Windows Defender não encontrado." -ForegroundColor Red
        Write-Log "ERRO: MpCmdRun.exe não localizado."
    }

    Write-Host "Varredura de malwares finalizada." -ForegroundColor Green
    Write-Log "Scan-AntiMalware finalizado."
}
